-- GigaChad Spy - Fixed & Tested Version
-- Fully compatible with executors

-- Safe service initialization
local function getService(serviceName)
    local success, service = pcall(function()
        return game:GetService(serviceName)
    end)
    return success and service or nil
end

-- Initialize services
local Players = getService("Players")
local RunService = getService("RunService") 
local HttpService = getService("HttpService")
local CoreGui = getService("CoreGui")

-- Check essential services
if not Players then
    warn("GigaChad Spy: Players service not available")
    return
end

local localPlayer = Players.LocalPlayer
if not localPlayer then
    warn("GigaChad Spy: LocalPlayer not found")
    return
end

-- Professional color scheme
local COLORS = {
    BACKGROUND = Color3.fromRGB(13, 17, 23),
    CARD = Color3.fromRGB(22, 27, 34),
    SURFACE = Color3.fromRGB(33, 38, 45),
    PRIMARY = Color3.fromRGB(47, 129, 247),
    SUCCESS = Color3.fromRGB(46, 160, 67),
    WARNING = Color3.fromRGB(219, 154, 4),
    ERROR = Color3.fromRGB(218, 54, 51),
    ACCENT = Color3.fromRGB(158, 91, 255),
    TEXT_PRIMARY = Color3.fromRGB(248, 250, 252),
    TEXT_SECONDARY = Color3.fromRGB(139, 148, 158)
}

-- Configuration
local MAX_LOGS = 100
local AUTO_BLOCK_THRESHOLD = 3

-- Data storage
local spyData = {
    logs = {},
    blockedRemotes = {},
    autoBlockCount = {},
    selectedLog = nil
}

-- Safe function wrapper
local function safeCall(func, errorMessage)
    local success, result = pcall(func)
    if not success then
        warn("GigaChad Spy: " .. (errorMessage or "Error") .. " - " .. tostring(result))
        return nil
    end
    return result
end

-- Safe value formatting
local function formatValue(value, depth)
    depth = depth or 0
    if depth > 2 then return "..." end
    
    if value == nil then return "nil" end
    
    local valueType = typeof(value)
    
    if valueType == "table" then
        local parts = {}
        for k, v in pairs(value) do
            if #parts < 3 then
                table.insert(parts, string.format("[%s] = %s", formatValue(k, depth + 1), formatValue(v, depth + 1)))
            else
                table.insert(parts, "...")
                break
            end
        end
        return "{" .. table.concat(parts, ", ") .. "}"
    elseif valueType == "string" then
        if #value > 30 then
            return string.format("%q...", string.sub(value, 1, 30))
        end
        return string.format("%q", value)
    elseif valueType == "number" then
        return tostring(value)
    elseif valueType == "boolean" then
        return tostring(value)
    elseif valueType == "Vector3" then
        return string.format("Vector3.new(%.1f, %.1f, %.1f)", value.X, value.Y, value.Z)
    elseif valueType == "CFrame" then
        local x, y, z = value.Position.X, value.Position.Y, value.Position.Z
        return string.format("CFrame.new(%.1f, %.1f, %.1f)", x, y, z)
    elseif valueType == "nil" then
        return "nil"
    else
        return string.format("--[[ %s ]]", valueType)
    end
end

-- Safe code generation
local function generateCode(remoteData)
    if not remoteData then return "-- Select a remote --" end
    
    local argsString = ""
    if remoteData.args and #remoteData.args > 0 then
        local argStrings = {}
        for i = 1, math.min(#remoteData.args, 10) do
            local arg = remoteData.args[i]
            table.insert(argStrings, string.format("    [%d] = %s", i, formatValue(arg)))
        end
        argsString = "local args = {\n" .. table.concat(argStrings, ",\n") .. "\n}"
    else
        argsString = "local args = {}"
    end

    local callString = ""
    if remoteData.isFunction then
        if remoteData.direction == "out" then
            callString = string.format('%s:InvokeServer(unpack(args))', remoteData.remotePath or "unknown")
        else
            callString = '-- Incoming function call'
        end
    else
        if remoteData.direction == "out" then
            callString = string.format('%s:FireServer(unpack(args))', remoteData.remotePath or "unknown")
        else
            callString = '-- Incoming event'
        end
    end

    return argsString .. "\n" .. callString
end

-- UI Creation Functions
local function createFrame(name, size, position, parent, color)
    return safeCall(function()
        local frame = Instance.new("Frame")
        frame.Name = name
        frame.Size = size
        frame.Position = position
        frame.BackgroundColor3 = color or COLORS.CARD
        frame.BorderSizePixel = 0
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = frame
        
        if parent then
            frame.Parent = parent
        end
        
        return frame
    end, "Create frame failed: " .. tostring(name))
end

local function createButton(name, size, position, parent, text, color)
    return safeCall(function()
        local button = Instance.new("TextButton")
        button.Name = name
        button.Size = size
        button.Position = position
        button.BackgroundColor3 = color or COLORS.PRIMARY
        button.Text = text
        button.TextColor3 = COLORS.TEXT_PRIMARY
        button.TextSize = 14
        button.Font = Enum.Font.Gotham
        button.BorderSizePixel = 0
        button.AutoButtonColor = false
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = button
        
        if parent then
            button.Parent = parent
        end
        
        return button
    end, "Create button failed: " .. tostring(name))
end

local function createLabel(name, size, position, parent, text, textSize)
    return safeCall(function()
        local label = Instance.new("TextLabel")
        label.Name = name
        label.Size = size
        label.Position = position
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = COLORS.TEXT_PRIMARY
        label.TextSize = textSize or 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextWrapped = true
        
        if parent then
            label.Parent = parent
        end
        
        return label
    end, "Create label failed: " .. tostring(name))
end

-- Main GUI Creation
local function createMainGUI()
    return safeCall(function()
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "GigaChadSpy"
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        screenGui.ResetOnSpawn = false
        
        -- Use CoreGui for better compatibility
        if CoreGui then
            screenGui.Parent = CoreGui
        else
            local playerGui = localPlayer:WaitForChild("PlayerGui")
            screenGui.Parent = playerGui
        end

        -- Floating button
        local floatButton = createButton(
            "FloatButton",
            UDim2.new(0, 60, 0, 60),
            UDim2.new(0, 20, 0.5, -30),
            screenGui,
            "SPY",
            COLORS.PRIMARY
        )
        if floatButton then
            floatButton.Visible = true
        end

        -- Main window
        local mainFrame = createFrame(
            "MainFrame",
            UDim2.new(0.9, 0, 0.85, 0),
            UDim2.new(0.05, 0, 0.075, 0),
            screenGui,
            COLORS.BACKGROUND
        )
        if mainFrame then
            mainFrame.Visible = false
        end

        -- Header
        local header = createFrame(
            "Header",
            UDim2.new(1, 0, 0, 50),
            UDim2.new(0, 0, 0, 0),
            mainFrame,
            COLORS.SURFACE
        )
        
        createLabel(
            "Title",
            UDim2.new(0.7, 0, 1, 0),
            UDim2.new(0, 15, 0, 0),
            header,
            "GIGACHAD SPY",
            16
        )
        
        local closeButton = createButton(
            "CloseButton",
            UDim2.new(0, 40, 0, 40),
            UDim2.new(1, -50, 0.5, -20),
            header,
            "X",
            COLORS.ERROR
        )

        -- Content area
        local contentFrame = createFrame(
            "ContentFrame",
            UDim2.new(1, -20, 1, -70),
            UDim2.new(0, 10, 0, 60),
            mainFrame,
            COLORS.BACKGROUND
        )
        if contentFrame then
            contentFrame.BackgroundTransparency = 1
        end

        -- Left panel - Remote list
        local leftPanel = createFrame(
            "LeftPanel",
            UDim2.new(0.4, 0, 1, 0),
            UDim2.new(0, 0, 0, 0),
            contentFrame,
            COLORS.SURFACE
        )
        
        local listHeader = createFrame(
            "ListHeader",
            UDim2.new(1, 0, 0, 40),
            UDim2.new(0, 0, 0, 0),
            leftPanel,
            COLORS.CARD
        )
        
        createLabel(
            "ListTitle",
            UDim2.new(1, -10, 1, 0),
            UDim2.new(0, 10, 0, 0),
            listHeader,
            "ACTIVE REMOTES",
            14
        )
        
        local remotesList = Instance.new("ScrollingFrame")
        remotesList.Name = "RemotesList"
        remotesList.Size = UDim2.new(1, 0, 1, -80)
        remotesList.Position = UDim2.new(0, 0, 0, 45)
        remotesList.BackgroundTransparency = 1
        remotesList.ScrollBarThickness = 4
        remotesList.ScrollBarImageColor3 = COLORS.PRIMARY
        remotesList.BorderSizePixel = 0
        
        if leftPanel then
            remotesList.Parent = leftPanel
        end
        
        local listLayout = Instance.new("UIListLayout")
        listLayout.Padding = UDim.new(0, 8)
        listLayout.Parent = remotesList

        -- Right panel - Code and controls
        local rightPanel = createFrame(
            "RightPanel",
            UDim2.new(0.58, 0, 1, 0),
            UDim2.new(0.42, 0, 0, 0),
            contentFrame,
            COLORS.SURFACE
        )
        
        local codeHeader = createFrame(
            "CodeHeader",
            UDim2.new(1, 0, 0, 40),
            UDim2.new(0, 0, 0, 0),
            rightPanel,
            COLORS.CARD
        )
        
        createLabel(
            "CodeTitle",
            UDim2.new(1, -10, 1, 0),
            UDim2.new(0, 10, 0, 0),
            codeHeader,
            "GENERATED CODE",
            14
        )
        
        local codeContainer = createFrame(
            "CodeContainer",
            UDim2.new(1, -10, 0.55, -10),
            UDim2.new(0, 5, 0, 45),
            rightPanel,
            COLORS.BACKGROUND
        )
        
        local codeBox = Instance.new("ScrollingFrame")
        codeBox.Name = "CodeBox"
        codeBox.Size = UDim2.new(1, -10, 1, -10)
        codeBox.Position = UDim2.new(0, 5, 0, 5)
        codeBox.BackgroundTransparency = 1
        codeBox.ScrollBarThickness = 4
        codeBox.ScrollBarImageColor3 = COLORS.PRIMARY
        codeBox.BorderSizePixel = 0
        
        if codeContainer then
            codeBox.Parent = codeContainer
        end
        
        local codeText = createLabel(
            "CodeText",
            UDim2.new(1, 0, 0, 0),
            UDim2.new(0, 0, 0, 0),
            codeBox,
            "-- Select a remote to view code --",
            13
        )
        if codeText then
            codeText.Size = UDim2.new(1, 0, 0, 0)
            codeText.AutomaticSize = Enum.AutomaticSize.Y
            codeText.TextYAlignment = Enum.TextYAlignment.Top
        end

        -- Control panel
        local controlPanel = createFrame(
            "ControlPanel",
            UDim2.new(1, -10, 0.4, -10),
            UDim2.new(0, 5, 0.55, 5),
            rightPanel,
            COLORS.CARD
        )
        
        local controlGrid = Instance.new("UIGridLayout")
        controlGrid.CellSize = UDim2.new(0.5, -8, 0.33, -8)
        controlGrid.CellPadding = UDim2.new(0, 6, 0, 6)
        
        if controlPanel then
            controlGrid.Parent = controlPanel
        end

        -- Control buttons
        local controlConfigs = {
            {Name = "Execute", Text = "Execute", Color = COLORS.SUCCESS},
            {Name = "Copy", Text = "Copy", Color = COLORS.PRIMARY},
            {Name = "Block", Text = "Block", Color = COLORS.ERROR},
            {Name = "Info", Text = "Info", Color = COLORS.ACCENT},
            {Name = "Clear", Text = "Clear", Color = COLORS.WARNING},
            {Name = "UnblockAll", Text = "Unblock All", Color = COLORS.SUCCESS}
        }

        for _, config in pairs(controlConfigs) do
            createButton(
                config.Name,
                UDim2.new(1, 0, 1, 0),
                UDim2.new(0, 0, 0, 0),
                controlPanel,
                config.Text,
                config.Color
            )
        end

        -- Status bar
        local statusBar = createFrame(
            "StatusBar",
            UDim2.new(1, 0, 0, 30),
            UDim2.new(0, 0, 1, -30),
            leftPanel,
            COLORS.CARD
        )
        
        local statusLabel = createLabel(
            "StatusLabel",
            UDim2.new(1, -10, 1, 0),
            UDim2.new(0, 10, 0, 0),
            statusBar,
            "Ready | Logs: 0 | Blocked: 0",
            12
        )
        if statusLabel then
            statusLabel.TextColor3 = COLORS.TEXT_SECONDARY
        end

        return {
            ScreenGui = screenGui,
            MainFrame = mainFrame,
            FloatButton = floatButton,
            CloseButton = closeButton,
            RemotesList = remotesList,
            CodeText = codeText,
            ControlPanel = controlPanel,
            StatusLabel = statusLabel
        }
    end, "Main GUI creation failed")
end

-- Simple and reliable hook system
local function initializeHooks()
    return safeCall(function()
        -- Hook incoming RemoteEvents
        local function hookRemoteEvent(remote)
            if remote:IsA("RemoteEvent") then
                remote.OnClientEvent:Connect(function(...)
                    local args = {...}
                    local remotePath = remote:GetFullName()
                    
                    if not spyData.blockedRemotes[remotePath] then
                        local logEntry = {
                            remote = remote,
                            remotePath = remotePath,
                            args = args,
                            isFunction = false,
                            direction = "in",
                            timestamp = tick()
                        }
                        
                        table.insert(spyData.logs, 1, logEntry)
                        
                        if #spyData.logs > MAX_LOGS then
                            table.remove(spyData.logs)
                        end
                    end
                end)
            end
        end

        -- Hook incoming RemoteFunctions  
        local function hookRemoteFunction(remote)
            if remote:IsA("RemoteFunction") then
                local oldOnClientInvoke = remote.OnClientInvoke
                if type(oldOnClientInvoke) == "function" then
                    remote.OnClientInvoke = function(...)
                        local args = {...}
                        local remotePath = remote:GetFullName()
                        
                        if not spyData.blockedRemotes[remotePath] then
                            local logEntry = {
                                remote = remote,
                                remotePath = remotePath,
                                args = args,
                                isFunction = true,
                                direction = "in",
                                timestamp = tick()
                            }
                            
                            table.insert(spyData.logs, 1, logEntry)
                            
                            if #spyData.logs > MAX_LOGS then
                                table.remove(spyData.logs)
                            end
                        end
                        
                        return oldOnClientInvoke(...)
                    end
                end
            end
        end

        -- Scan and hook all existing remotes
        local function hookExistingRemotes(parent)
            for _, child in pairs(parent:GetChildren()) do
                if child:IsA("RemoteEvent") then
                    hookRemoteEvent(child)
                elseif child:IsA("RemoteFunction") then
                    hookRemoteFunction(child)
                end
                hookExistingRemotes(child)
            end
        end
        
        hookExistingRemotes(game)
        
        -- Hook new remotes as they're added
        game.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("RemoteEvent") then
                hookRemoteEvent(descendant)
            elseif descendant:IsA("RemoteFunction") then
                hookRemoteFunction(descendant)
            end
        end)
        
        return true
    end, "Hook initialization failed")
end

-- Action functions
local function executeRemote(remoteData)
    if not remoteData or not remoteData.remote then
        return false, "Invalid remote data"
    end
    
    return safeCall(function()
        local args = {}
        if remoteData.args then
            for i, arg in ipairs(remoteData.args) do
                args[i] = arg
            end
        end
        
        if remoteData.isFunction then
            return true, remoteData.remote:InvokeServer(unpack(args))
        else
            remoteData.remote:FireServer(unpack(args))
            return true, "Event fired successfully"
        end
    end, "Remote execution failed")
end

local function toggleBlockRemote(remotePath)
    if not remotePath then return false end
    
    return safeCall(function()
        if spyData.blockedRemotes[remotePath] then
            spyData.blockedRemotes[remotePath] = nil
            return false
        else
            spyData.blockedRemotes[remotePath] = true
            return true
        end
    end, "Block toggle failed")
end

local function getRemoteInfo(remoteData)
    if not remoteData then return "No remote selected" end
    
    return safeCall(function()
        return string.format("Path: %s\nType: %s\nDirection: %s\nTime: %.2f\nArgs: %d",
            remoteData.remotePath or "unknown",
            remoteData.isFunction and "Function" or "Event",
            remoteData.direction or "unknown",
            remoteData.timestamp or 0,
            #(remoteData.args or {})
        )
    end, "Info retrieval failed") or "Error getting information"
end

-- GUI update function
local function updateGUI(guiElements)
    if not guiElements then return false end
    
    return safeCall(function()
        local remotesList = guiElements.RemotesList
        local codeText = guiElements.CodeText
        local statusLabel = guiElements.StatusLabel
        
        if not remotesList or not codeText or not statusLabel then
            return false
        end

        -- Clear existing list
        for _, child in pairs(remotesList:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end

        -- Add remote entries
        for i, logEntry in ipairs(spyData.logs) do
            local card = createFrame(
                "RemoteCard_" .. i,
                UDim2.new(1, -8, 0, 60),
                UDim2.new(0, 4, 0, (i-1)*68),
                remotesList,
                COLORS.CARD
            )
            
            if card then
                -- Remote path
                local path = logEntry.remotePath or "unknown"
                if #path > 25 then
                    path = "..." .. string.sub(path, -22)
                end
                
                createLabel(
                    "PathLabel",
                    UDim2.new(0.8, 0, 0.5, 0),
                    UDim2.new(0, 8, 0, 5),
                    card,
                    path,
                    12
                )
                
                -- Info line
                local info = string.format("%s ‚Ä¢ %s ‚Ä¢ %d args",
                    logEntry.isFunction and "FUNC" or "EVENT",
                    logEntry.direction or "unknown",
                    #(logEntry.args or {})
                )
                
                local infoLabel = createLabel(
                    "InfoLabel",
                    UDim2.new(0.8, 0, 0.4, 0),
                    UDim2.new(0, 8, 0.5, 0),
                    card,
                    info,
                    10
                )
                if infoLabel then
                    infoLabel.TextColor3 = COLORS.TEXT_SECONDARY
                end

                -- Block indicator
                if logEntry.remotePath and spyData.blockedRemotes[logEntry.remotePath] then
                    createFrame(
                        "BlockIndicator",
                        UDim2.new(0, 8, 0, 8),
                        UDim2.new(1, -14, 0, 8),
                        card,
                        COLORS.ERROR
                    )
                end

                -- Click handler
                card.MouseButton1Click:Connect(function()
                    spyData.selectedLog = logEntry
                    codeText.Text = generateCode(logEntry)
                end)
            end
        end
        
        -- Update scroll size
        remotesList.CanvasSize = UDim2.new(0, 0, 0, #spyData.logs * 68)
        
        -- Update status
        local blockedCount = 0
        for _ in pairs(spyData.blockedRemotes) do
            blockedCount = blockedCount + 1
        end
        statusLabel.Text = string.format("Logs: %d | Blocked: %d", #spyData.logs, blockedCount)
        
        return true
    end, "GUI update failed")
end

-- Main initialization
local function initializeSpy()
    print("GigaChad Spy: Initializing...")
    
    local guiElements = createMainGUI()
    if not guiElements then
        error("Failed to create GUI")
        return false
    end

    -- Safe event connection helper
    local function connectButton(button, callback)
        if button and button:IsA("TextButton") then
            button.MouseButton1Click:Connect(function()
                safeCall(callback, "Button callback failed")
            end)
        end
    end

    -- UI event handlers
    connectButton(guiElements.FloatButton, function()
        guiElements.MainFrame.Visible = not guiElements.MainFrame.Visible
        guiElements.FloatButton.Visible = not guiElements.MainFrame.Visible
    end)

    connectButton(guiElements.CloseButton, function()
        guiElements.MainFrame.Visible = false
        guiElements.FloatButton.Visible = true
    end)

    -- Control button handlers
    local controlHandlers = {
        Execute = function()
            if spyData.selectedLog then
                local success, result = executeRemote(spyData.selectedLog)
                if success then
                    guiElements.CodeText.Text = generateCode(spyData.selectedLog) .. "\n\n‚úÖ " .. tostring(result)
                else
                    guiElements.CodeText.Text = generateCode(spyData.selectedLog) .. "\n\n‚ùå " .. tostring(result)
                end
            end
        end,
        
        Copy = function()
            if spyData.selectedLog then
                local code = generateCode(spyData.selectedLog)
                if setclipboard then
                    setclipboard(code)
                    guiElements.CodeText.Text = code .. "\n\n‚úÖ Copied to clipboard"
                else
                    guiElements.CodeText.Text = code .. "\n\n‚ùå Clipboard not available"
                end
            end
        end,
        
        Block = function()
            if spyData.selectedLog and spyData.selectedLog.remotePath then
                local isBlocked = toggleBlockRemote(spyData.selectedLog.remotePath)
                guiElements.CodeText.Text = generateCode(spyData.selectedLog) .. 
                    (isBlocked and "\n\n‚úÖ Remote blocked" or "\n\n‚úÖ Remote unblocked")
            end
        end,
        
        Info = function()
            if spyData.selectedLog then
                local info = getRemoteInfo(spyData.selectedLog)
                guiElements.CodeText.Text = "üìä REMOTE INFO\n" .. info .. "\n\n" .. generateCode(spyData.selectedLog)
            end
        end,
        
        Clear = function()
            spyData.logs = {}
            spyData.selectedLog = nil
            guiElements.CodeText.Text = "-- Select a remote to view code --"
            updateGUI(guiElements)
        end,
        
        UnblockAll = function()
            spyData.blockedRemotes = {}
            guiElements.CodeText.Text = "‚úÖ All blocks cleared"
            updateGUI(guiElements)
        end
    }

    -- Connect all control buttons
    for controlName, handler in pairs(controlHandlers) do
        local button = guiElements.ControlPanel:FindFirstChild(controlName)
        connectButton(button, handler)
    end

    -- Initialize hooks
    initializeHooks()

    -- Auto-update GUI
    local lastUpdate = 0
    local updateConnection = RunService.Heartbeat:Connect(function()
        if tick() - lastUpdate > 0.3 then
            if guiElements.ScreenGui.Parent then
                updateGUI(guiElements)
                lastUpdate = tick()
            else
                updateConnection:Disconnect()
            end
        end
    end)

    return true
end

-- Start the spy
if not _G.GigaChadSpyLoaded then
    _G.GigaChadSpyLoaded = true
    local success, err = pcall(initializeSpy)
    if success then
        print("GigaChad Spy: ‚úÖ Loaded successfully")
    else
        warn("GigaChad Spy: ‚ùå Failed to load - " .. tostring(err))
        _G.GigaChadSpyLoaded = false
    end
else
    print("GigaChad Spy: ‚ö†Ô∏è Already loaded")
end
